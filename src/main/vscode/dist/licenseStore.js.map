{"version":3,"file":"licenseStore.js","sourceRoot":"","sources":["../src/licenseStore.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,uCAAyB;AACzB,uCAAyB;AACzB,2CAA6B;AAU7B,MAAM,YAAY,GAAG,IAAI,CAAC,IAAI,CAC5B,EAAE,CAAC,OAAO,EAAE,EACZ,QAAQ,EACR,uBAAuB,EACvB,cAAc,CACf,CAAC;AAEF,SAAS,eAAe;IACtB,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;IACvC,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC;QACxB,EAAE,CAAC,SAAS,CAAC,GAAG,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;IACzC,CAAC;AACH,CAAC;AAED,MAAa,YAAY;IAGvB;QACE,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC;IAChC,CAAC;IAED,QAAQ;QACN,OAAO,IAAI,CAAC,KAAK,CAAC;IACpB,CAAC;IAED,MAAM,CAAC,OAA8B;QACnC,IAAI,CAAC,KAAK,GAAG;YACX,GAAG,IAAI,CAAC,KAAK;YACb,GAAG,OAAO;SACX,CAAC;QACF,IAAI,CAAC,OAAO,EAAE,CAAC;QACf,OAAO,IAAI,CAAC,KAAK,CAAC;IACpB,CAAC;IAED,KAAK;QACH,IAAI,CAAC,KAAK,GAAG;YACX,KAAK,EAAE,IAAI;YACX,UAAU,EAAE,IAAI;YAChB,OAAO,EAAE,KAAK;YACd,eAAe,EAAE,CAAC;YAClB,WAAW,EAAE,IAAI;SAClB,CAAC;QACF,IAAI,CAAC,OAAO,EAAE,CAAC;IACjB,CAAC;IAEO,SAAS;QACf,IAAI,CAAC;YACH,MAAM,GAAG,GAAG,EAAE,CAAC,YAAY,CAAC,YAAY,EAAE,MAAM,CAAC,CAAC;YAClD,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAC/B,OAAO;gBACL,KAAK,EAAE,MAAM,CAAC,KAAK,IAAI,IAAI;gBAC3B,UAAU,EAAE,MAAM,CAAC,UAAU,IAAI,MAAM,CAAC,WAAW,IAAI,IAAI;gBAC3D,OAAO,EAAE,OAAO,CAAC,MAAM,CAAC,OAAO,CAAC;gBAChC,eAAe,EAAE,MAAM,CAAC,MAAM,CAAC,eAAe,IAAI,MAAM,CAAC,aAAa,IAAI,CAAC,CAAC;gBAC5E,WAAW,EAAE,MAAM,CAAC,WAAW,IAAI,IAAI;aACxC,CAAC;QACJ,CAAC;QAAC,MAAM,CAAC;YACP,OAAO;gBACL,KAAK,EAAE,IAAI;gBACX,UAAU,EAAE,IAAI;gBAChB,OAAO,EAAE,KAAK;gBACd,eAAe,EAAE,CAAC;gBAClB,WAAW,EAAE,IAAI;aAClB,CAAC;QACJ,CAAC;IACH,CAAC;IAEO,OAAO;QACb,eAAe,EAAE,CAAC;QAClB,EAAE,CAAC,aAAa,CAAC,YAAY,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;IAC9E,CAAC;CACF;AAzDD,oCAyDC","sourcesContent":["import * as fs from \"fs\";\nimport * as os from \"os\";\nimport * as path from \"path\";\n\nexport interface LicenseState {\n  email?: string | null;\n  licenseKey?: string | null;\n  isValid: boolean;\n  lastCheckMillis: number;\n  lastMessage?: string | null;\n}\n\nconst LICENSE_FILE = path.join(\n  os.homedir(),\n  \".cache\",\n  \"phpstorm-time-tracker\",\n  \"license.json\",\n);\n\nfunction ensureParentDir(): void {\n  const dir = path.dirname(LICENSE_FILE);\n  if (!fs.existsSync(dir)) {\n    fs.mkdirSync(dir, { recursive: true });\n  }\n}\n\nexport class LicenseStore {\n  private state: LicenseState;\n\n  constructor() {\n    this.state = this.readState();\n  }\n\n  getState(): LicenseState {\n    return this.state;\n  }\n\n  update(partial: Partial<LicenseState>): LicenseState {\n    this.state = {\n      ...this.state,\n      ...partial,\n    };\n    this.persist();\n    return this.state;\n  }\n\n  clear(): void {\n    this.state = {\n      email: null,\n      licenseKey: null,\n      isValid: false,\n      lastCheckMillis: 0,\n      lastMessage: null,\n    };\n    this.persist();\n  }\n\n  private readState(): LicenseState {\n    try {\n      const raw = fs.readFileSync(LICENSE_FILE, \"utf8\");\n      const parsed = JSON.parse(raw);\n      return {\n        email: parsed.email ?? null,\n        licenseKey: parsed.licenseKey ?? parsed.license_key ?? null,\n        isValid: Boolean(parsed.isValid),\n        lastCheckMillis: Number(parsed.lastCheckMillis ?? parsed.last_check_ms ?? 0),\n        lastMessage: parsed.lastMessage ?? null,\n      };\n    } catch {\n      return {\n        email: null,\n        licenseKey: null,\n        isValid: false,\n        lastCheckMillis: 0,\n        lastMessage: null,\n      };\n    }\n  }\n\n  private persist(): void {\n    ensureParentDir();\n    fs.writeFileSync(LICENSE_FILE, JSON.stringify(this.state, null, 2), \"utf8\");\n  }\n}\n"]}